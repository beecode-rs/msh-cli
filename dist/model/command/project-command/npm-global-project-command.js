import { compareVersions } from 'compare-versions';
import stringify from 'fast-json-stable-stringify';
import path from 'path';
import { fileService } from '#src/service/file-service';
import { config } from '#src/util/config';
import { logger } from '#src/util/logger';
export class NpmGlobalProjectCommand {
    // eslint-disable-next-line @typescript-eslint/require-await
    async execute() {
        try {
            const depsByProject = this._allDepsByProject();
            logger().debug('all dependencies all projects', depsByProject);
            const uniquePackages = this._uniquePackages(depsByProject);
            logger().debug('add dependencies by package', uniquePackages);
            const versionConflictWarningMessage = this._versionConflictWarningMessage(uniquePackages);
            logger().debug('version conflict warning message', versionConflictWarningMessage);
            const highestDependencies = this._highestDependencies(uniquePackages);
            const highestDependenciesString = JSON.stringify(highestDependencies, Object.keys(highestDependencies).sort(), 2);
            logger().debug('highest dependencies', highestDependenciesString);
            this._overrideGlobalDepsWithNewHighestDependencies(highestDependencies);
            return [
                {
                    errorMessage: versionConflictWarningMessage.join('\n\n'),
                    name: 'Global NPM Dependencies',
                    stringResult: `Gathered dependencies \n\n${highestDependenciesString}`,
                },
            ];
            // eslint-disable-next-line @typescript-eslint/no-explicit-any
        }
        catch (err) {
            return [{ errorMessage: err.message }];
        }
    }
    _allDepsByProject() {
        return config()
            .projects.map((project) => {
            const packageJs = this._packageJsonForProject(project);
            const projectDeps = { ...packageJs.dependencies, ...packageJs.devDependencies };
            const cleanProjectDeps = this._removeIgnoredPackages(projectDeps);
            return { [project]: cleanProjectDeps };
        })
            .reduce((acc, cur) => Object.assign(acc, cur), {});
    }
    _removeIgnoredPackages(dependencies) {
        const { globalIgnorePackages } = config().npm;
        if (globalIgnorePackages.length === 0) {
            return dependencies;
        }
        return Object.entries(dependencies)
            .filter(([packageName]) => !globalIgnorePackages.includes(packageName))
            .reduce((acc, [packageName, version]) => ({ ...acc, [packageName]: version }), {});
    }
    _uniquePackages(depsByProject) {
        const result = {};
        Object.entries(depsByProject).forEach(([project, deps]) => {
            Object.entries(deps).forEach(([packageName, version]) => {
                const pk = (result[packageName] = result[packageName] ?? { versionProject: {}, versions: [] });
                if (!pk.versions.includes(version)) {
                    pk.versions.push(version);
                }
                const pv = (pk.versionProject[version] = pk.versionProject[version] ?? []);
                pv.push(project);
            });
        });
        return result;
    }
    _versionConflictWarningMessage(uniquePackages) {
        return Object.entries(uniquePackages)
            .filter(([_, { versions }]) => versions.length > 1)
            .sort((a, b) => {
            const [pnA] = a;
            const [pnB] = b;
            if (pnA < pnB) {
                return -1;
            }
            if (pnA > pnB) {
                return 1;
            }
            return 0;
        })
            .map(([packageName, uniquePackInfo]) => {
            return `${packageName}: ${stringify(uniquePackInfo.versions)}\n${Object.entries(uniquePackInfo.versionProject)
                .map(([v, prjs]) => `${v}:${stringify(prjs)}`)
                .join('\n')}`;
        });
    }
    _highestDependencies(uniquePackages) {
        return Object.entries(uniquePackages)
            .map(([packageName, { versions }]) => ({ [packageName]: this._highestVersion(versions) }))
            .reduce((acc, cur) => Object.assign(acc, cur), {});
    }
    _highestVersion(versions) {
        const sortedVersions = versions.sort(compareVersions);
        const result = sortedVersions.pop();
        if (!result) {
            throw new Error(`Missing version in array [${stringify(versions)}]`);
        }
        return result;
    }
    _overrideGlobalDepsWithNewHighestDependencies(highestDependencies) {
        const globalPackageJs = this._packageJsonForProject();
        globalPackageJs.dependencies = highestDependencies;
        const fileData = JSON.stringify(JSON.parse(stringify(globalPackageJs)), null, 2);
        fileService.writeToFileSync({ data: fileData, filePath: 'package.json' });
    }
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    _packageJsonForProject(project) {
        return import(path.join(process.cwd(), [project, 'package.json'].filter(Boolean).join('/')));
    }
}
export const npmGlobalProjectCommandFactory = (...params) => new NpmGlobalProjectCommand(...params);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibnBtLWdsb2JhbC1wcm9qZWN0LWNvbW1hbmQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbW9kZWwvY29tbWFuZC9wcm9qZWN0LWNvbW1hbmQvbnBtLWdsb2JhbC1wcm9qZWN0LWNvbW1hbmQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ2xELE9BQU8sU0FBUyxNQUFNLDRCQUE0QixDQUFBO0FBQ2xELE9BQU8sSUFBSSxNQUFNLE1BQU0sQ0FBQTtBQUd2QixPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sMkJBQTJCLENBQUE7QUFDdkQsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGtCQUFrQixDQUFBO0FBQ3pDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQTtBQVV6QyxNQUFNLE9BQU8sdUJBQXVCO0lBQ25DLDREQUE0RDtJQUM1RCxLQUFLLENBQUMsT0FBTztRQUNaLElBQUksQ0FBQztZQUNKLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFBO1lBQzlDLE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQywrQkFBK0IsRUFBRSxhQUFhLENBQUMsQ0FBQTtZQUU5RCxNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGFBQWEsQ0FBQyxDQUFBO1lBQzFELE1BQU0sRUFBRSxDQUFDLEtBQUssQ0FBQyw2QkFBNkIsRUFBRSxjQUFjLENBQUMsQ0FBQTtZQUU3RCxNQUFNLDZCQUE2QixHQUFHLElBQUksQ0FBQyw4QkFBOEIsQ0FBQyxjQUFjLENBQUMsQ0FBQTtZQUN6RixNQUFNLEVBQUUsQ0FBQyxLQUFLLENBQUMsa0NBQWtDLEVBQUUsNkJBQTZCLENBQUMsQ0FBQTtZQUVqRixNQUFNLG1CQUFtQixHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxjQUFjLENBQUMsQ0FBQTtZQUNyRSxNQUFNLHlC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QWUsQ0FBQyxZQUFZLEdBQUcsbUJBQW1CLENBQUE7UUFDbEQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQTtRQUNoRixXQUFXLENBQUMsZUFBZSxDQUFDLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxRQUFRLEVBQUUsY0FBYyxFQUFFLENBQUMsQ0FBQTtJQUMxRSxDQUFDO0lBRUQsOERBQThEO0lBQ3BELHNCQUFzQixDQUFDLE9BQWdCO1FBQ2hELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBQzdGLENBQUM7Q0FDRDtBQUVELE1BQU0sQ0FBQyxNQUFNLDhCQUE4QixHQUFHLENBQzdDLEdBQUcsTUFBNkQsRUFDdEMsRUFBRSxDQUFDLElBQUksdUJBQXVCLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvbXBhcmVWZXJzaW9ucyB9IGZyb20gJ2NvbXBhcmUtdmVyc2lvbnMnXG5pbXBvcnQgc3RyaW5naWZ5IGZyb20gJ2Zhc3QtanNvbi1zdGFibGUtc3RyaW5naWZ5J1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCdcblxuaW1wb3J0IHsgdHlwZSBFeGVjdXRhYmxlLCB0eXBlIEV4ZWN1dGVSZXN1bHQgfSBmcm9tICcjc3JjL21vZGVsL2NvbW1hbmQvaW50ZXJmYWNlcydcbmltcG9ydCB7IGZpbGVTZXJ2aWNlIH0gZnJvbSAnI3NyYy9zZXJ2aWNlL2ZpbGUtc2VydmljZSdcbmltcG9ydCB7IGNvbmZpZyB9IGZyb20gJyNzcmMvdXRpbC9jb25maWcnXG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICcjc3JjL3V0aWwvbG9nZ2VyJ1xuXG5leHBvcnQgdHlwZSBWZXJzaW9uT25Qcm9qZWN0cyA9IFJlY29yZDxzdHJpbmcsIHN0cmluZ1tdPlxuXG5leHBvcnQgdHlwZSBVbmlxdWVQYWNrYWdlcyA9IFJlY29yZDxzdHJpbmcsIHsgdmVyc2lvbnM6IHN0cmluZ1tdOyB2ZXJzaW9uUHJvamVjdDogVmVyc2lvbk9uUHJvamVjdHMgfT5cblxuZXhwb3J0IHR5cGUgRGVwZW5kZW5jaWVzT2JqZWN0ID0gUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuXG5leHBvcnQgdHlwZSBQcm9qZWN0V2l0aERlcGVuZGVuY2llcyA9IFJlY29yZDxzdHJpbmcsIERlcGVuZGVuY2llc09iamVjdD5cblxuZXhwb3J0IGNsYXNzIE5wbUdsb2JhbFByb2plY3RDb21tYW5kIGltcGxlbWVudHMgRXhlY3V0YWJsZSB7XG5cdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvcmVxdWlyZS1hd2FpdFxuXHRhc3luYyBleGVjdXRlKCk6IFByb21pc2U8RXhlY3V0ZVJlc3VsdFtdPiB7XG5cdFx0dHJ5IHtcblx0XHRcdGNvbnN0IGRlcHNCeVByb2plY3QgPSB0aGlzLl9hbGxEZXBzQnlQcm9qZWN0KClcblx0XHRcdGxvZ2dlcigpLmRlYnVnKCdhbGwgZGVwZW5kZW5jaWVzIGFsbCBwcm9qZWN0cycsIGRlcHNCeVByb2plY3QpXG5cblx0XHRcdGNvbnN0IHVuaXF1ZVBhY2thZ2VzID0gdGhpcy5fdW5pcXVlUGFja2FnZXMoZGVwc0J5UHJvamVjdClcblx0XHRcdGxvZ2dlcigpLmRlYnVnKCdhZGQgZGVwZW5kZW5jaWVzIGJ5IHBhY2thZ2UnLCB1bmlxdWVQYWNrYWdlcylcblxuXHRcdFx0Y29uc3QgdmVyc2lvbkNvbmZsaWN0V2FybmluZ01lc3NhZ2UgPSB0aGlzLl92ZXJzaW9uQ29uZmxpY3RXYXJuaW5nTWVzc2FnZSh1bmlxdWVQYWNrYWdlcylcblx0XHRcdGxvZ2dlcigpLmRlYnVnKCd2ZXJzaW9uIGNvbmZsaWN0IHdhcm5pbmcgbWVzc2FnZScsIHZlcnNpb25Db25mbGljdFdhcm5pbmdNZXNzYWdlKVxuXG5cdFx0XHRjb25zdCBoaWdoZXN0RGVwZW5kZW5jaWVzID0gdGhpcy5faGlnaGVzdERlcGVuZGVuY2llcyh1bmlxdWVQYWNrYWdlcylcblx0XHRcdGNvbnN0IGhpZ2hlc3REZXBlbmRlbmNpZXNTdHJpbmcgPSBKU09OLnN0cmluZ2lmeShoaWdoZXN0RGVwZW5kZW5jaWVzLCBPYmplY3Qua2V5cyhoaWdoZXN0RGVwZW5kZW5jaWVzKS5zb3J0KCksIDIpXG5cdFx0XHRsb2dnZXIoKS5kZWJ1ZygnaGlnaGVzdCBkZXBlbmRlbmNpZXMnLCBoaWdoZXN0RGVwZW5kZW5jaWVzU3RyaW5nKVxuXG5cdFx0XHR0aGlzLl9vdmVycmlkZUdsb2JhbERlcHNXaXRoTmV3SGlnaGVzdERlcGVuZGVuY2llcyhoaWdoZXN0RGVwZW5kZW5jaWVzKVxuXG5cdFx0XHRyZXR1cm4gW1xuXHRcdFx0XHR7XG5cdFx0XHRcdFx0ZXJyb3JNZXNzYWdlOiB2ZXJzaW9uQ29uZmxpY3RXYXJuaW5nTWVzc2FnZS5qb2luKCdcXG5cXG4nKSxcblx0XHRcdFx0XHRuYW1lOiAnR2xvYmFsIE5QTSBEZXBlbmRlbmNpZXMnLFxuXHRcdFx0XHRcdHN0cmluZ1Jlc3VsdDogYEdhdGhlcmVkIGRlcGVuZGVuY2llcyBcXG5cXG4ke2hpZ2hlc3REZXBlbmRlbmNpZXNTdHJpbmd9YCxcblx0XHRcdFx0fSxcblx0XHRcdF1cblx0XHRcdC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG5cdFx0fSBjYXRjaCAoZXJyOiBhbnkpIHtcblx0XHRcdHJldHVybiBbeyBlcnJvck1lc3NhZ2U6IGVyci5tZXNzYWdlIH1dXG5cdFx0fVxuXHR9XG5cblx0cHJvdGVjdGVkIF9hbGxEZXBzQnlQcm9qZWN0KCk6IFByb2plY3RXaXRoRGVwZW5kZW5jaWVzIHtcblx0XHRyZXR1cm4gY29uZmlnKClcblx0XHRcdC5wcm9qZWN0cy5tYXAoKHByb2plY3Q6IHN0cmluZykgPT4ge1xuXHRcdFx0XHRjb25zdCBwYWNrYWdlSnMgPSB0aGlzLl9wYWNrYWdlSnNvbkZvclByb2plY3QocHJvamVjdClcblx0XHRcdFx0Y29uc3QgcHJvamVjdERlcHMgPSB7IC4uLnBhY2thZ2VKcy5kZXBlbmRlbmNpZXMsIC4uLnBhY2thZ2VKcy5kZXZEZXBlbmRlbmNpZXMgfVxuXHRcdFx0XHRjb25zdCBjbGVhblByb2plY3REZXBzID0gdGhpcy5fcmVtb3ZlSWdub3JlZFBhY2thZ2VzKHByb2plY3REZXBzKVxuXG5cdFx0XHRcdHJldHVybiB7IFtwcm9qZWN0XTogY2xlYW5Qcm9qZWN0RGVwcyB9XG5cdFx0XHR9KVxuXHRcdFx0LnJlZHVjZSgoYWNjOiBQcm9qZWN0V2l0aERlcGVuZGVuY2llcywgY3VyOiBQcm9qZWN0V2l0aERlcGVuZGVuY2llcykgPT4gT2JqZWN0LmFzc2lnbihhY2MsIGN1ciksIHt9KVxuXHR9XG5cblx0cHJvdGVjdGVkIF9yZW1vdmVJZ25vcmVkUGFja2FnZXMoZGVwZW5kZW5jaWVzOiBEZXBlbmRlbmNpZXNPYmplY3QpOiBEZXBlbmRlbmNpZXNPYmplY3Qge1xuXHRcdGNvbnN0IHsgZ2xvYmFsSWdub3JlUGFja2FnZXMgfSA9IGNvbmZpZygpLm5wbVxuXHRcdGlmIChnbG9iYWxJZ25vcmVQYWNrYWdlcy5sZW5ndGggPT09IDApIHtcblx0XHRcdHJldHVybiBkZXBlbmRlbmNpZXNcblx0XHR9XG5cblx0XHRyZXR1cm4gT2JqZWN0LmVudHJpZXMoZGVwZW5kZW5jaWVzKVxuXHRcdFx0LmZpbHRlcigoW3BhY2thZ2VOYW1lXSkgPT4gIWdsb2JhbElnbm9yZVBhY2thZ2VzLmluY2x1ZGVzKHBhY2thZ2VOYW1lKSlcblx0XHRcdC5yZWR1Y2UoKGFjYywgW3BhY2thZ2VOYW1lLCB2ZXJzaW9uXSkgPT4gKHsgLi4uYWNjLCBbcGFja2FnZU5hbWVdOiB2ZXJzaW9uIH0pLCB7fSlcblx0fVxuXG5cdHByb3RlY3RlZCBfdW5pcXVlUGFja2FnZXMoZGVwc0J5UHJvamVjdDogUHJvamVjdFdpdGhEZXBlbmRlbmNpZXMpOiBVbmlxdWVQYWNrYWdlcyB7XG5cdFx0Y29uc3QgcmVzdWx0OiBVbmlxdWVQYWNrYWdlcyA9IHt9XG5cdFx0T2JqZWN0LmVudHJpZXMoZGVwc0J5UHJvamVjdCkuZm9yRWFjaCgoW3Byb2plY3QsIGRlcHNdKSA9PiB7XG5cdFx0XHRPYmplY3QuZW50cmllcyhkZXBzKS5mb3JFYWNoKChbcGFja2FnZU5hbWUsIHZlcnNpb25dKSA9PiB7XG5cdFx0XHRcdGNvbnN0IHBrID0gKHJlc3VsdFtwYWNrYWdlTmFtZV0gPSByZXN1bHRbcGFja2FnZU5hbWVdID8/IHsgdmVyc2lvblByb2plY3Q6IHt9LCB2ZXJzaW9uczogW10gfSlcblx0XHRcdFx0aWYgKCFway52ZXJzaW9ucy5pbmNsdWRlcyh2ZXJzaW9uKSkge1xuXHRcdFx0XHRcdHBrLnZlcnNpb25zLnB1c2godmVyc2lvbilcblx0XHRcdFx0fVxuXHRcdFx0XHRjb25zdCBwdiA9IChway52ZXJzaW9uUHJvamVjdFt2ZXJzaW9uXSA9IHBrLnZlcnNpb25Qcm9qZWN0W3ZlcnNpb25dID8/IFtdKVxuXHRcdFx0XHRwdi5wdXNoKHByb2plY3QpXG5cdFx0XHR9KVxuXHRcdH0pXG5cblx0XHRyZXR1cm4gcmVzdWx0XG5cdH1cblxuXHRwcm90ZWN0ZWQgX3ZlcnNpb25Db25mbGljdFdhcm5pbmdNZXNzYWdlKHVuaXF1ZVBhY2thZ2VzOiBVbmlxdWVQYWNrYWdlcyk6IHN0cmluZ1tdIHtcblx0XHRyZXR1cm4gT2JqZWN0LmVudHJpZXModW5pcXVlUGFja2FnZXMpXG5cdFx0XHQuZmlsdGVyKChbXywgeyB2ZXJzaW9ucyB9XSkgPT4gdmVyc2lvbnMubGVuZ3RoID4gMSlcblx0XHRcdC5zb3J0KChhLCBiKSA9PiB7XG5cdFx0XHRcdGNvbnN0IFtwbkFdID0gYVxuXHRcdFx0XHRjb25zdCBbcG5CXSA9IGJcblx0XHRcdFx0aWYgKHBuQSA8IHBuQikge1xuXHRcdFx0XHRcdHJldHVybiAtMVxuXHRcdFx0XHR9XG5cdFx0XHRcdGlmIChwbkEgPiBwbkIpIHtcblx0XHRcdFx0XHRyZXR1cm4gMVxuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmV0dXJuIDBcblx0XHRcdH0pXG5cdFx0XHQubWFwKChbcGFja2FnZU5hbWUsIHVuaXF1ZVBhY2tJbmZvXSkgPT4ge1xuXHRcdFx0XHRyZXR1cm4gYCR7cGFja2FnZU5hbWV9OiAke3N0cmluZ2lmeSh1bmlxdWVQYWNrSW5mby52ZXJzaW9ucyl9XFxuJHtPYmplY3QuZW50cmllcyh1bmlxdWVQYWNrSW5mby52ZXJzaW9uUHJvamVjdClcblx0XHRcdFx0XHQubWFwKChbdiwgcHJqc10pID0+IGAke3Z9OiR7c3RyaW5naWZ5KHByanMpfWApXG5cdFx0XHRcdFx0LmpvaW4oJ1xcbicpfWBcblx0XHRcdH0pXG5cdH1cblxuXHRwcm90ZWN0ZWQgX2hpZ2hlc3REZXBlbmRlbmNpZXModW5pcXVlUGFja2FnZXM6IFVuaXF1ZVBhY2thZ2VzKTogRGVwZW5kZW5jaWVzT2JqZWN0IHtcblx0XHRyZXR1cm4gT2JqZWN0LmVudHJpZXModW5pcXVlUGFja2FnZXMpXG5cdFx0XHQubWFwKChbcGFja2FnZU5hbWUsIHsgdmVyc2lvbnMgfV0pID0+ICh7IFtwYWNrYWdlTmFtZV06IHRoaXMuX2hpZ2hlc3RWZXJzaW9uKHZlcnNpb25zKSB9KSlcblx0XHRcdC5yZWR1Y2UoKGFjYywgY3VyKSA9PiBPYmplY3QuYXNzaWduKGFjYywgY3VyKSwge30pXG5cdH1cblxuXHRwcm90ZWN0ZWQgX2hpZ2hlc3RWZXJzaW9uKHZlcnNpb25zOiBzdHJpbmdbXSk6IHN0cmluZyB7XG5cdFx0Y29uc3Qgc29ydGVkVmVyc2lvbnMgPSB2ZXJzaW9ucy5zb3J0KGNvbXBhcmVWZXJzaW9ucylcblx0XHRjb25zdCByZXN1bHQgPSBzb3J0ZWRWZXJzaW9ucy5wb3AoKVxuXHRcdGlmICghcmVzdWx0KSB7XG5cdFx0XHR0aHJvdyBuZXcgRXJyb3IoYE1pc3NpbmcgdmVyc2lvbiBpbiBhcnJheSBbJHtzdHJpbmdpZnkodmVyc2lvbnMpfV1gKVxuXHRcdH1cblxuXHRcdHJldHVybiByZXN1bHRcblx0fVxuXG5cdHByb3RlY3RlZCBfb3ZlcnJpZGVHbG9iYWxEZXBzV2l0aE5ld0hpZ2hlc3REZXBlbmRlbmNpZXMoaGlnaGVzdERlcGVuZGVuY2llczogRGVwZW5kZW5jaWVzT2JqZWN0KTogdm9pZCB7XG5cdFx0Y29uc3QgZ2xvYmFsUGFja2FnZUpzID0gdGhpcy5fcGFja2FnZUpzb25Gb3JQcm9qZWN0KClcblx0XHRnbG9iYWxQYWNrYWdlSnMuZGVwZW5kZW5jaWVzID0gaGlnaGVzdERlcGVuZGVuY2llc1xuXHRcdGNvbnN0IGZpbGVEYXRhID0gSlNPTi5zdHJpbmdpZnkoSlNPTi5wYXJzZShzdHJpbmdpZnkoZ2xvYmFsUGFja2FnZUpzKSksIG51bGwsIDIpXG5cdFx0ZmlsZVNlcnZpY2Uud3JpdGVUb0ZpbGVTeW5jKHsgZGF0YTogZmlsZURhdGEsIGZpbGVQYXRoOiAncGFja2FnZS5qc29uJyB9KVxuXHR9XG5cblx0Ly8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcblx0cHJvdGVjdGVkIF9wYWNrYWdlSnNvbkZvclByb2plY3QocHJvamVjdD86IHN0cmluZyk6IGFueSB7XG5cdFx0cmV0dXJuIGltcG9ydChwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgW3Byb2plY3QsICdwYWNrYWdlLmpzb24nXS5maWx0ZXIoQm9vbGVhbikuam9pbignLycpKSlcblx0fVxufVxuXG5leHBvcnQgY29uc3QgbnBtR2xvYmFsUHJvamVjdENvbW1hbmRGYWN0b3J5ID0gKFxuXHQuLi5wYXJhbXM6IENvbnN0cnVjdG9yUGFyYW1ldGVyczx0eXBlb2YgTnBtR2xvYmFsUHJvamVjdENvbW1hbmQ+XG4pOiBOcG1HbG9iYWxQcm9qZWN0Q29tbWFuZCA9PiBuZXcgTnBtR2xvYmFsUHJvamVjdENvbW1hbmQoLi4ucGFyYW1zKVxuIl19